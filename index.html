<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meu Controle</title>
    
    <!-- ================= PWA / NATIVE APP SETUP ================= -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Meu Controle">
    <meta name="theme-color" content="#292524">
    <!-- Manifest Inline para Android reconhecer como App -->
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Meu%20Controle%22%2C%22short_name%22%3A%22Controle%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23fdf8f5%22%2C%22theme_color%22%3A%22%23292524%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23fb7185%22%2F%3E%3Ctext%20y%3D%2255%22%20x%3D%2250%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-size%3D%2250%22%3E%E2%9A%A1%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23fb7185%22/><text y=%2255%22 x=%2250%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2250%22>⚡</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Configuração do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', 'sans-serif'] },
                    colors: {
                        retro: {
                            dark: '#292524',
                            cream: '#fef3c7',
                            yellow: '#fcd34d',
                            teal: '#2dd4bf',
                            pink: '#fb7185',
                            orange: '#fb923c',
                            blue: '#38bdf8'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fef3c7; border-left: 2px solid #292524; }
        ::-webkit-scrollbar-thumb { background: #fb923c; border: 2px solid #292524; border-radius: 0px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        
        .retro-shadow { box-shadow: 4px 4px 0px #292524; }
        .retro-shadow-lg { box-shadow: 8px 8px 0px #292524; }
        .retro-border { border: 3px solid #292524; }
        
        .retro-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px #292524;
        }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        [v-cloak] { display: none; }
    </style>

    <!-- Import Map para Vue e Firebase -->
    <script type="importmap">
        {
            "imports": {
                "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
                "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
            }
        }
    </script>
</head>
<body class="bg-[#fdf8f5] font-sans text-retro-dark h-screen overflow-hidden selection:bg-retro-yellow selection:text-retro-dark">

    <div id="app" class="h-full w-full flex items-center justify-center p-0 md:p-6" v-cloak>
        
        <!-- ================= TELA DE LOGIN ================= -->
        <div v-if="!user && !authLoading" class="w-full max-w-md p-8 bg-retro-cream retro-border md:rounded-2xl retro-shadow-lg h-full md:h-auto flex flex-col justify-center animate-fade-in relative overflow-hidden z-10">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-retro-yellow rounded-full retro-border retro-shadow opacity-50"></div>
            <div class="absolute -bottom-8 -left-8 w-24 h-24 bg-retro-blue retro-border retro-shadow transform rotate-12 opacity-50"></div>

            <div class="text-center mb-10 relative z-10">
                <div class="bg-retro-pink w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-5 retro-border retro-shadow transform -rotate-3">
                    <i class="fa-solid fa-bolt text-2xl text-retro-dark transform rotate-3"></i>
                </div>
                <h1 class="text-4xl font-black text-retro-dark tracking-tighter uppercase">O Meu Controlo</h1>
                <p class="text-retro-dark font-black text-xs mt-2 uppercase tracking-widest bg-retro-teal inline-block px-3 py-1 retro-border retro-shadow">
                    <i class="fa-solid fa-key text-xs mr-1"></i> Acesso Seguro
                </p>
            </div>

            <div v-if="authError" class="bg-red-400 text-retro-dark p-3 rounded-xl text-sm font-black text-center retro-border retro-shadow mb-6 flex items-center justify-center">
                <i class="fa-solid fa-circle-exclamation mr-2"></i> {{ authError }}
            </div>

            <form @submit.prevent="handleAuth" class="space-y-5 relative z-10">
                <div>
                    <label class="block text-sm font-black text-retro-dark mb-2 uppercase tracking-wider">E-mail</label>
                    <input v-model="email" type="email" required class="w-full bg-white retro-border rounded-xl p-3.5 text-sm font-bold outline-none focus:bg-retro-cream transition-colors text-retro-dark retro-shadow">
                </div>
                <div>
                    <label class="block text-sm font-black text-retro-dark mb-2 uppercase tracking-wider">Palavra-passe</label>
                    <input v-model="password" type="password" required minlength="6" class="w-full bg-white retro-border rounded-xl p-3.5 text-sm font-bold outline-none focus:bg-retro-cream transition-colors text-retro-dark retro-shadow">
                </div>
                <button type="submit" :disabled="loading" class="w-full bg-retro-teal text-retro-dark retro-border retro-shadow retro-btn font-black p-4 rounded-xl transition-all text-sm uppercase tracking-widest mt-6 flex justify-center items-center">
                    <i v-if="loading" class="fa-solid fa-spinner fa-spin mr-2"></i>
                    {{ isLogin ? 'Entrar' : 'Criar Conta' }}
                </button>
            </form>

            <button @click="toggleAuthMode" class="mt-8 text-sm font-black text-retro-dark hover:text-retro-orange transition-colors text-center w-full z-10 relative underline decoration-2 underline-offset-4">
                {{ isLogin ? 'Não tens conta? Regista-te' : 'Já tens conta? Iniciar sessão' }}
            </button>
        </div>

        <!-- ================= ECRÃ DE CARREGAMENTO ================= -->
        <div v-else-if="authLoading" class="flex flex-col items-center justify-center space-y-4 w-full h-full">
            <div class="w-16 h-16 bg-retro-yellow retro-border retro-shadow rounded-full flex items-center justify-center animate-spin">
                <i class="fa-solid fa-star text-retro-dark text-2xl"></i>
            </div>
            <p class="font-black text-retro-dark tracking-widest uppercase text-sm bg-white px-4 py-1 retro-border retro-shadow">A carregar...</p>
        </div>

        <!-- ================= APLICAÇÃO PRINCIPAL ================= -->
        <div v-else class="flex flex-col md:flex-row h-full w-full max-w-6xl bg-white md:rounded-3xl retro-shadow-lg relative overflow-hidden border-0 md:border-[3px] border-retro-dark">
            
            <!-- MENU LATERAL (DESKTOP) -->
            <aside class="hidden md:flex flex-col w-72 bg-retro-cream border-r-[3px] border-retro-dark p-6 z-20">
                <div class="mb-10 mt-4 text-center">
                    <div class="bg-retro-pink w-14 h-14 rounded-xl flex items-center justify-center mx-auto mb-4 retro-border retro-shadow transform rotate-3">
                        <i class="fa-solid fa-bolt text-xl text-retro-dark"></i>
                    </div>
                    <h1 class="text-2xl font-black text-retro-dark tracking-tighter uppercase">O Meu Controlo</h1>
                    <p class="text-xs font-bold text-retro-dark mt-2 truncate bg-white border-2 border-retro-dark inline-block px-2 py-0.5 rounded-md shadow-[2px_2px_0px_#292524]">{{ user.email }}</p>
                </div>

                <nav class="flex-1 space-y-3">
                    <button @click="activeTab = 'resumo'" :class="activeTab === 'resumo' ? 'bg-retro-teal retro-shadow' : 'bg-white hover:bg-gray-50 shadow-[2px_2px_0px_#292524]'" class="w-full flex items-center p-3.5 rounded-xl font-black transition-all text-sm border-2 border-retro-dark text-retro-dark">
                        <i class="fa-solid fa-chart-pie text-lg mr-3 w-6 text-center"></i> Visão Geral
                    </button>
                    <button @click="activeTab = 'fixos'" :class="activeTab === 'fixos' ? 'bg-retro-yellow retro-shadow' : 'bg-white hover:bg-gray-50 shadow-[2px_2px_0px_#292524]'" class="w-full flex items-center p-3.5 rounded-xl font-black transition-all text-sm border-2 border-retro-dark text-retro-dark">
                        <i class="fa-solid fa-money-bill-transfer text-lg mr-3 w-6 text-center"></i> Contas & Faturas
                    </button>
                    <button @click="activeTab = 'diario'" :class="activeTab === 'diario' ? 'bg-retro-pink retro-shadow' : 'bg-white hover:bg-gray-50 shadow-[2px_2px_0px_#292524]'" class="w-full flex items-center p-3.5 rounded-xl font-black transition-all text-sm border-2 border-retro-dark text-retro-dark">
                        <i class="fa-solid fa-cart-shopping text-lg mr-3 w-6 text-center"></i> Lançamentos
                    </button>
                </nav>

                <div class="space-y-3 pt-6 border-t-[3px] border-retro-dark border-dashed">
                    <button @click="confirmReset" class="w-full flex items-center p-3.5 rounded-xl font-black text-retro-dark bg-white border-2 border-retro-dark shadow-[2px_2px_0px_#292524] hover:bg-gray-50 transition-all text-sm">
                        <i class="fa-solid fa-rotate-right mr-3 w-6 text-center"></i> Limpar Mês
                    </button>
                    <button @click="logout" class="w-full flex items-center p-3.5 rounded-xl font-black text-white bg-retro-dark border-2 border-retro-dark retro-shadow hover:bg-black transition-all text-sm">
                        <i class="fa-solid fa-arrow-right-from-bracket mr-3 w-6 text-center"></i> Sair da Conta
                    </button>
                </div>
            </aside>

            <!-- ÁREA DE CONTEÚDO PRINCIPAL -->
            <main class="flex-1 flex flex-col h-full bg-[#fdf8f5] relative">
                <!-- Padrão de fundo -->
                <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#292524 2px, transparent 2px); background-size: 20px 20px;"></div>
                
                <!-- CABEÇALHO COM SALDO -->
                <header class="bg-retro-dark text-retro-cream p-6 pt-8 shadow-md z-10 shrink-0 mb-0 pb-8 relative border-b-[3px] border-retro-dark">
                    <button @click="logout" class="md:hidden absolute top-5 right-5 text-retro-cream hover:text-white p-2">
                        <i class="fa-solid fa-arrow-right-from-bracket text-lg"></i>
                    </button>
                    
                    <h2 class="text-xl font-black tracking-tighter uppercase md:hidden mb-6 flex items-center">
                        <div class="w-8 h-8 bg-retro-pink rounded-lg flex items-center justify-center mr-3 border-2 border-retro-cream">
                            <i class="fa-solid fa-bolt text-sm text-retro-dark"></i>
                        </div>
                        O Meu Controlo
                    </h2>
                    
                    <div class="max-w-4xl mx-auto relative z-10">
                        <p class="text-retro-yellow text-xs font-black uppercase tracking-widest mb-1">Saldo Disponível</p>
                        <h2 class="text-4xl md:text-5xl font-black tracking-tighter mb-4">{{ formatCurrency(balance) }}</h2>
                        <div class="flex gap-4">
                            <div class="bg-retro-teal text-retro-dark px-3 py-1.5 rounded-lg border-2 border-retro-dark retro-shadow flex items-center text-xs font-black uppercase tracking-wider">
                                <i class="fa-solid fa-arrow-up mr-2"></i>
                                <span>{{ formatCurrency(totalIncome) }}</span>
                            </div>
                            <div class="bg-retro-pink text-retro-dark px-3 py-1.5 rounded-lg border-2 border-retro-dark retro-shadow flex items-center text-xs font-black uppercase tracking-wider">
                                <i class="fa-solid fa-arrow-down mr-2"></i>
                                <span>{{ formatCurrency(totalFixed) }}</span>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- CONTEÚDO COM SCROLL -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8 pb-28 md:pb-8 relative z-10">
                    <div class="max-w-4xl mx-auto">
                        
                        <!-- ================= ABA: VISÃO GERAL ================= -->
                        <div v-if="activeTab === 'resumo'" class="space-y-6 animate-fade-in">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-retro-teal p-5 rounded-2xl retro-border retro-shadow flex flex-col justify-center">
                                    <p class="text-[10px] text-retro-dark mb-1 font-black uppercase tracking-widest"><i class="fa-solid fa-circle-check mr-1"></i> Recebido</p>
                                    <p class="font-black text-retro-dark text-xl md:text-2xl">{{ formatCurrency(receivedIncome) }}</p>
                                </div>
                                <div class="bg-retro-pink p-5 rounded-2xl retro-border retro-shadow flex flex-col justify-center">
                                    <p class="text-[10px] text-retro-dark mb-1 font-black uppercase tracking-widest"><i class="fa-solid fa-circle-check mr-1"></i> Pago</p>
                                    <p class="font-black text-retro-dark text-xl md:text-2xl">{{ formatCurrency(paidFixed) }}</p>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl retro-border retro-shadow p-6 space-y-6 mt-6">
                                <div class="border-b-[3px] border-retro-dark pb-4">
                                    <h4 class="font-black text-sm text-retro-dark uppercase tracking-widest"><i class="fa-solid fa-bullseye mr-2 text-retro-blue"></i> Orçamentos Variáveis</h4>
                                </div>
                                
                                <div v-for="budget in budgets" :key="budget.id" class="space-y-3">
                                    <div class="flex justify-between items-end">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 retro-border shadow-[2px_2px_0px_#292524] bg-white text-retro-dark">
                                                <i :class="budget.icon + ' text-base'"></i>
                                            </div>
                                            <div>
                                                <p class="text-base font-black text-retro-dark">{{ budget.name }}</p>
                                                <p class="text-[10px] font-black text-gray-500 uppercase tracking-wider">Restam {{ formatCurrency(budget.limit - getBudgetSpent(budget.id)) }}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="font-black text-retro-dark">{{ formatCurrency(getBudgetSpent(budget.id)) }}</span>
                                            <span class="text-gray-500 text-xs font-bold ml-1">/ {{ formatCurrency(budget.limit) }}</span>
                                        </div>
                                    </div>
                                    <div class="w-full bg-retro-cream retro-border rounded-full h-4 overflow-hidden shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                        <div class="h-full border-r-[3px] border-retro-dark transition-all duration-1000 relative"
                                             :class="getBudgetPercentage(budget.id) > 85 ? 'bg-red-500' : budget.color"
                                             :style="{ width: Math.min(getBudgetPercentage(budget.id), 100) + '%' }">
                                             <div class="absolute inset-0 opacity-20" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 20px);"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ================= ABA: CONTAS E FATURAS ================= -->
                        <div v-if="activeTab === 'fixos'" class="space-y-8 animate-fade-in">
                            
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <h3 class="text-xl font-black text-retro-dark uppercase tracking-tighter"><i class="fa-solid fa-money-bill-transfer mr-2 text-retro-orange"></i> Gestão de Contas</h3>
                                <button @click="isEditing = !isEditing" class="bg-retro-yellow retro-border text-retro-dark retro-shadow retro-btn px-4 py-2 rounded-xl font-black text-sm transition-all flex items-center uppercase tracking-wider">
                                    <i :class="isEditing ? 'fa-solid fa-check mr-2' : 'fa-solid fa-pen-to-square mr-2'"></i>
                                    {{ isEditing ? 'Concluir' : 'Editar' }}
                                </button>
                            </div>

                            <!-- RENDAS -->
                            <section>
                                <div class="flex items-center justify-between mb-4 px-1 bg-white retro-border p-3 rounded-xl shadow-[4px_4px_0px_#292524]">
                                    <h4 class="text-sm font-black text-retro-dark uppercase tracking-widest"><i class="fa-solid fa-arrow-down mr-2 text-retro-teal"></i>Entradas</h4>
                                    <span class="text-[10px] font-black text-retro-dark bg-retro-teal retro-border px-2 py-1 rounded-md shadow-[2px_2px_0px_#292524]">{{ incomes.filter(i => i.received).length }} / {{ incomes.length }} OK</span>
                                </div>
                                
                                <div class="space-y-3">
                                    <div v-for="income in incomes" :key="income.id" class="bg-white retro-border rounded-2xl p-4 retro-shadow flex items-center justify-between gap-4 relative overflow-hidden">
                                        <div v-if="income.received && !isEditing" class="absolute left-0 top-0 bottom-0 w-2 bg-retro-teal border-r-[3px] border-retro-dark"></div>
                                        
                                        <template v-if="!isEditing">
                                            <div class="flex items-center gap-3 pl-2">
                                                <div>
                                                    <p class="font-black text-retro-dark text-base uppercase" :class="income.received ? 'line-through decoration-2 decoration-retro-teal opacity-70' : ''">{{ income.name }}</p>
                                                    <p class="font-black text-retro-dark text-lg" :class="income.received ? 'opacity-70' : ''">{{ formatCurrency(income.amount) }}</p>
                                                </div>
                                            </div>
                                            <button @click="toggleStatus(income, 'received')" class="w-12 h-12 rounded-xl retro-border flex items-center justify-center retro-btn transition-colors shrink-0" :class="income.received ? 'bg-retro-teal shadow-[2px_2px_0px_#292524]' : 'bg-gray-100 shadow-[2px_2px_0px_#292524] hover:bg-retro-cream'">
                                                <i class="fa-solid" :class="income.received ? 'fa-check text-retro-dark' : 'fa-hand-pointer text-gray-400'"></i>
                                            </button>
                                        </template>

                                        <template v-else>
                                            <div class="flex flex-1 items-center gap-3 w-full">
                                                <button @click="removeItem('incomes', income.id)" class="bg-retro-pink retro-border shadow-[2px_2px_0px_#292524] retro-btn text-retro-dark w-10 h-10 rounded-xl flex items-center justify-center shrink-0"><i class="fa-solid fa-trash-can"></i></button>
                                                <input v-model="income.name" type="text" class="flex-1 bg-retro-cream retro-border rounded-xl p-2.5 text-sm font-black text-retro-dark outline-none focus:bg-white shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                <input v-model.number="income.amount" type="number" class="w-24 md:w-32 bg-retro-cream retro-border rounded-xl p-2.5 text-sm font-black text-retro-dark outline-none focus:bg-white shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <div v-if="isEditing" class="bg-retro-teal retro-border retro-shadow rounded-2xl p-4 mt-4">
                                        <p class="text-xs font-black text-retro-dark uppercase tracking-widest mb-2"><i class="fa-solid fa-plus mr-1"></i> Nova Entrada</p>
                                        <form @submit.prevent="addItem('incomes')" class="flex flex-col sm:flex-row gap-3">
                                            <input v-model="newItem.name" type="text" placeholder="Nome" required class="flex-1 bg-white retro-border rounded-xl p-3 text-sm font-black outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                            <div class="flex gap-3 w-full sm:w-auto">
                                                <input v-model.number="newItem.amount" type="number" step="0.01" placeholder="€ 0,00" required class="flex-1 sm:w-32 bg-white retro-border rounded-xl p-3 text-sm font-black outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                <button type="submit" class="bg-retro-yellow retro-border shadow-[2px_2px_0px_#292524] retro-btn text-retro-dark p-3 rounded-xl px-4 font-black shrink-0"><i class="fa-solid fa-check"></i></button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </section>

                            <!-- SAÍDAS FIXAS & CARTÕES DE CRÉDITO -->
                            <section>
                                <div class="flex items-center justify-between mb-4 px-1 bg-white retro-border p-3 rounded-xl shadow-[4px_4px_0px_#292524]">
                                    <h4 class="text-sm font-black text-retro-dark uppercase tracking-widest"><i class="fa-solid fa-arrow-up mr-2 text-retro-pink"></i>Saídas & Faturas</h4>
                                    <span class="text-[10px] font-black text-retro-dark bg-retro-pink retro-border px-2 py-1 rounded-md shadow-[2px_2px_0px_#292524]">{{ fixedExpenses.filter(e => e.paid).length }} / {{ fixedExpenses.length }} OK</span>
                                </div>

                                <div class="space-y-4">
                                    <div v-for="expense in fixedExpenses" :key="expense.id" class="bg-white retro-border rounded-2xl p-4 retro-shadow flex flex-col gap-3 relative overflow-hidden transition-opacity" :class="expense.paid && !isEditing ? 'opacity-80' : ''">
                                        
                                        <div v-if="expense.paid && !isEditing" class="absolute left-0 top-0 bottom-0 w-2 bg-retro-pink border-r-[3px] border-retro-dark"></div>

                                        <div class="flex items-center justify-between gap-2 w-full">
                                            <template v-if="!isEditing">
                                                <div class="flex items-center gap-3 pl-2 flex-1">
                                                    <div>
                                                        <p class="font-black text-retro-dark text-base uppercase" :class="expense.paid ? 'line-through decoration-2 decoration-retro-pink' : ''">
                                                            <i v-if="expense.isCard" class="fa-regular fa-credit-card mr-2 text-retro-pink"></i> 
                                                            {{ expense.name }}
                                                        </p>
                                                        <p class="font-black text-retro-dark text-lg" :class="expense.paid ? 'opacity-70' : ''">{{ formatCurrency(getExpenseAmount(expense)) }}</p>
                                                    </div>
                                                </div>
                                                <button @click="toggleStatus(expense, 'paid')" class="w-12 h-12 rounded-xl retro-border flex items-center justify-center retro-btn transition-colors shrink-0" :class="expense.paid ? 'bg-retro-pink shadow-[2px_2px_0px_#292524]' : 'bg-gray-100 shadow-[2px_2px_0px_#292524] hover:bg-retro-cream'">
                                                    <i class="fa-solid" :class="expense.paid ? 'fa-check text-retro-dark' : 'fa-hand-pointer text-gray-400'"></i>
                                                </button>
                                            </template>
                                            <template v-else>
                                                <div class="flex flex-1 items-center gap-2 w-full">
                                                    <button @click="removeItem('fixedExpenses', expense.id)" class="bg-retro-pink retro-border shadow-[2px_2px_0px_#292524] retro-btn text-retro-dark w-10 h-10 rounded-xl flex items-center justify-center shrink-0"><i class="fa-solid fa-trash-can"></i></button>
                                                    <input v-model="expense.name" type="text" class="flex-1 w-full bg-retro-cream retro-border rounded-xl p-2.5 text-sm font-black text-retro-dark outline-none focus:bg-white shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                    <input v-if="!expense.isCard" v-model.number="expense.amount" type="number" class="w-24 md:w-32 bg-retro-cream retro-border rounded-xl p-2.5 text-sm font-black text-retro-dark outline-none focus:bg-white shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                </div>
                                            </template>
                                        </div>

                                        <!-- Tópicos do Cartão -->
                                        <div v-if="expense.isCard && !isEditing && expense.subItems && expense.subItems.length > 0" class="pl-4 ml-1 border-l-[3px] border-dashed border-retro-dark/30 space-y-1.5 w-full mt-1">
                                            <div v-for="sub in expense.subItems" :key="sub.id" class="flex justify-between items-center text-[11px] font-black text-retro-dark" :class="expense.paid ? 'opacity-50 line-through decoration-retro-pink' : 'opacity-80'">
                                                <span class="uppercase tracking-widest"><i class="fa-solid fa-caret-right mr-1"></i>{{ sub.name }}</span>
                                                <span>{{ formatCurrency(sub.amount) }}</span>
                                            </div>
                                        </div>

                                        <div v-if="expense.isCard && isEditing" class="pl-4 ml-[52px] border-l-[3px] border-dashed border-retro-dark/30 space-y-2 w-full pr-1">
                                            <div v-for="(sub, idx) in expense.subItems" :key="sub.id" class="flex gap-2 w-full">
                                                <input v-model="sub.name" type="text" placeholder="Tópico" class="flex-1 min-w-0 bg-white retro-border rounded-lg p-2 text-xs font-black text-retro-dark outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                <input v-model.number="sub.amount" type="number" placeholder="€ 0" class="w-20 sm:w-24 bg-white retro-border rounded-lg p-2 text-xs font-black text-retro-dark outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                <button @click="expense.subItems.splice(idx, 1)" class="text-retro-pink hover:text-red-600 px-1 shrink-0"><i class="fa-solid fa-xmark text-lg"></i></button>
                                            </div>
                                            <button @click="expense.subItems.push({id: Date.now(), name: '', amount: null})" class="text-[10px] bg-retro-yellow retro-border shadow-[2px_2px_0px_#292524] px-2.5 py-1.5 rounded-lg font-black uppercase tracking-wider retro-btn inline-flex items-center">
                                                <i class="fa-solid fa-plus mr-1"></i> Adicionar Tópico
                                            </button>
                                        </div>
                                    </div>

                                    <div v-if="isEditing" class="bg-retro-pink retro-border retro-shadow rounded-2xl p-4 mt-4">
                                        <p class="text-xs font-black text-retro-dark uppercase tracking-widest mb-2"><i class="fa-solid fa-plus mr-1"></i> Nova Saída / Fatura</p>
                                        <form @submit.prevent="addItem('fixedExpenses')" class="flex flex-col gap-3">
                                            <div class="flex flex-col sm:flex-row gap-3">
                                                <input v-model="newItem.name" type="text" placeholder="Nome (Ex: Fatura Cartão)" required class="flex-1 bg-white retro-border rounded-xl p-3 text-sm font-black outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                <div class="flex gap-3 w-full sm:w-auto">
                                                    <input v-if="!newItem.isCard" v-model.number="newItem.amount" type="number" step="0.01" placeholder="€ 0,00" required class="flex-1 sm:w-32 bg-white retro-border rounded-xl p-3 text-sm font-black outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                                    <button type="submit" class="bg-retro-yellow retro-border shadow-[2px_2px_0px_#292524] retro-btn text-retro-dark p-3 rounded-xl px-4 font-black shrink-0"><i class="fa-solid fa-check"></i></button>
                                                </div>
                                            </div>
                                            <label class="flex items-center gap-2 cursor-pointer mt-1">
                                                <input type="checkbox" v-model="newItem.isCard" class="w-4 h-4 accent-retro-dark retro-border cursor-pointer">
                                                <span class="text-[11px] font-black text-retro-dark uppercase tracking-wider bg-white border-2 border-retro-dark px-2 py-0.5 rounded shadow-[2px_2px_0px_#292524]">Fatura com vários tópicos</span>
                                            </label>
                                        </form>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <!-- ================= ABA: LANÇAMENTOS DIÁRIOS E SCANNER ================= -->
                        <div v-if="activeTab === 'diario'" class="space-y-6 animate-fade-in">
                            
                            <!-- Scanner Inteligente -->
                            <div class="bg-retro-yellow retro-border retro-shadow rounded-2xl p-6">
                                <h3 class="font-black text-retro-dark mb-4 text-base uppercase tracking-tighter"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Leitor Inteligente (IA)</h3>
                                
                                <div class="relative bg-white retro-border rounded-xl p-6 text-center transition-colors hover:bg-retro-cream cursor-pointer group">
                                    <input type="file" accept="image/*" @change="handleScan" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                    <div class="relative z-0">
                                        <div class="w-12 h-12 bg-retro-pink rounded-full border-2 border-retro-dark flex items-center justify-center mx-auto mb-3 shadow-[2px_2px_0px_#292524] group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-camera text-white text-lg"></i>
                                        </div>
                                        <p class="font-black uppercase tracking-tighter text-sm">Escanear Fatura/Recibo</p>
                                        <p class="text-[9px] font-bold text-gray-500 mt-1 uppercase tracking-widest">A inteligência lê os itens por ti!</p>
                                    </div>
                                </div>

                                <div v-if="isProcessing" class="mt-4 p-4 bg-white retro-border rounded-xl flex flex-col items-center">
                                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2 text-retro-teal"></i>
                                    <p class="font-black text-xs uppercase tracking-widest text-retro-dark">A ler o recibo...</p>
                                </div>

                                <div v-if="scannedItems.length > 0 && !isProcessing" class="mt-4 bg-white retro-border rounded-xl p-4">
                                    <p class="text-[10px] font-black uppercase tracking-widest mb-2 border-b-2 border-dashed border-retro-dark pb-1">Itens Identificados</p>
                                    <div class="max-h-32 overflow-y-auto space-y-1">
                                        <div v-for="item in scannedItems" class="flex justify-between text-[10px] font-bold uppercase">
                                            <span class="truncate pr-2">{{ item.qty }}x {{ item.name }}</span>
                                            <span class="font-black">{{ formatCurrency(item.price) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lançamento Manual -->
                            <div class="bg-white retro-border retro-shadow rounded-2xl p-6">
                                <h3 class="font-black text-retro-dark mb-4 text-base uppercase tracking-tighter"><i class="fa-solid fa-pen mr-2"></i> Novo Lançamento</h3>
                                <form @submit.prevent="addDailyExpense" class="space-y-4">
                                    <input v-model="newExpense.name" type="text" placeholder="O QUE COMPRASTE? (EX: MERCADO, UBER)" required class="w-full bg-[#fdf8f5] retro-border rounded-xl p-4 text-sm font-black text-retro-dark outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)] placeholder:text-gray-400">
                                    <div class="flex gap-4">
                                        <input v-model.number="newExpense.amount" type="number" step="0.01" placeholder="VALOR" required class="flex-1 bg-[#fdf8f5] retro-border rounded-xl p-4 text-sm font-black text-retro-dark outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)]">
                                        <select v-model="newExpense.budgetId" class="flex-1 bg-[#fdf8f5] retro-border rounded-xl p-4 text-sm font-black text-retro-dark outline-none focus:bg-retro-cream shadow-[inset_2px_2px_0px_rgba(0,0,0,0.1)] appearance-none cursor-pointer">
                                            <option v-for="b in budgets" :value="b.id">{{ b.name }}</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-retro-teal text-retro-dark retro-border retro-shadow retro-btn font-black p-4 rounded-xl text-sm uppercase tracking-widest flex items-center justify-center">
                                        <i class="fa-solid fa-check mr-2"></i> Guardar Lançamento
                                    </button>
                                </form>
                            </div>

                            <section>
                                <h3 class="text-xs font-black text-retro-dark mb-4 uppercase tracking-widest bg-white border-2 border-retro-dark inline-block px-3 py-1.5 rounded-xl shadow-[2px_2px_0px_#292524]"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Últimos Lançamentos</h3>
                                
                                <div v-if="dailyExpenses.length === 0" class="text-center py-8 text-retro-dark bg-white rounded-2xl retro-border retro-shadow border-dashed">
                                    <p class="text-sm font-black uppercase tracking-widest">Nenhum registo.</p>
                                </div>
                                
                                <div v-else class="space-y-3">
                                    <div v-for="expense in dailyExpenses" :key="expense.id" class="bg-white retro-border rounded-2xl p-4 retro-shadow flex items-center justify-between gap-4">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 retro-border shadow-[2px_2px_0px_#292524]" :class="getBudget(expense.budgetId).color + ' text-retro-dark'">
                                                <i :class="getBudget(expense.budgetId).icon + ' text-base'"></i>
                                            </div>
                                            <div>
                                                <p class="font-black text-retro-dark text-sm uppercase leading-tight mb-0.5">{{ expense.name }}</p>
                                                <p class="text-[9px] bg-retro-cream border border-retro-dark px-1.5 rounded font-black text-retro-dark uppercase inline-block">{{ expense.date }} • {{ getBudget(expense.budgetId).name }}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="font-black text-retro-dark text-lg mr-3 bg-retro-yellow border-2 border-retro-dark px-1.5 py-0.5 rounded shadow-[2px_2px_0px_#292524]">{{ formatCurrency(expense.amount) }}</span>
                                            <button @click="removeItem('dailyExpenses', expense.id)" class="bg-retro-pink retro-border text-retro-dark shadow-[2px_2px_0px_#292524] retro-btn w-8 h-8 rounded-lg flex items-center justify-center"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                    </div>
                </div>

                <!-- NAVEGAÇÃO MOBILE (EM BAIXO) -->
                <nav class="md:hidden fixed bottom-0 left-0 w-full bg-[#fdf8f5] border-t-[3px] border-retro-dark flex justify-between z-50 pb-safe">
                    <button @click="activeTab = 'resumo'" class="flex flex-col items-center justify-center w-full py-3 text-[10px] font-black uppercase tracking-widest transition-all border-r-[3px] border-retro-dark" :class="activeTab === 'resumo' ? 'bg-retro-teal text-retro-dark' : 'bg-white text-retro-dark hover:bg-retro-cream'">
                        <i class="fa-solid fa-chart-pie text-xl mb-1"></i> Resumo
                    </button>
                    <button @click="activeTab = 'fixos'" class="flex flex-col items-center justify-center w-full py-3 text-[10px] font-black uppercase tracking-widest transition-all border-r-[3px] border-retro-dark" :class="activeTab === 'fixos' ? 'bg-retro-yellow text-retro-dark' : 'bg-white text-retro-dark hover:bg-retro-cream'">
                        <i class="fa-solid fa-wallet text-xl mb-1"></i> Faturas
                    </button>
                    <button @click="activeTab = 'diario'" class="flex flex-col items-center justify-center w-full py-3 text-[10px] font-black uppercase tracking-widest transition-all" :class="activeTab === 'diario' ? 'bg-retro-pink text-retro-dark' : 'bg-white text-retro-dark hover:bg-retro-cream'">
                        <i class="fa-solid fa-camera text-xl mb-1"></i> Lançar
                    </button>
                </nav>

                <!-- MODAL DE CONFIRMAÇÃO -->
                <div v-if="showModal" class="fixed inset-0 bg-retro-dark/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-retro-cream retro-border rounded-2xl p-6 max-w-sm w-full retro-shadow-lg relative overflow-hidden">
                        <div class="text-center mb-6 mt-2">
                            <h3 class="text-2xl font-black text-retro-dark mb-2 uppercase tracking-tighter">{{ modalData.title }}</h3>
                            <p class="text-sm font-bold text-retro-dark bg-white border-2 border-retro-dark rounded-xl p-3 shadow-[inset_2px_2px_0px_rgba(0,0,0,0.05)]">{{ modalData.message }}</p>
                        </div>
                        <div class="flex flex-col gap-3">
                            <button @click="confirmModalAction" class="w-full bg-retro-pink text-retro-dark retro-border retro-shadow retro-btn font-black p-3 rounded-xl uppercase tracking-widest text-sm">Confirmar</button>
                            <button @click="showModal = false" class="w-full bg-white text-retro-dark retro-border retro-shadow retro-btn font-black p-3 rounded-xl uppercase tracking-widest text-sm">Cancelar</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- SCRIPT DA APLICAÇÃO (VUE 3 + FIREBASE + GEMINI AI) -->
    <script type="module">
        import { createApp, ref, computed, watch, onMounted } from 'vue';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc } from 'firebase/firestore';

        // --- Configuração Firebase (Fornecida) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsB3qC7w0CixsEngzdnZQaEpekVQ1XilY",
            authDomain: "controlefinanceiro-111d6.firebaseapp.com",
            projectId: "controlefinanceiro-111d6",
            storageBucket: "controlefinanceiro-111d6.firebasestorage.app",
            messagingSenderId: "406440351725",
            appId: "1:406440351725:web:4dc05ffb6094027933f9e4",
            measurementId: "G-723F00TE9H"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- Chave do Gemini injetada no ambiente ---
        const apiKey = ""; 

        // --- Dados Iniciais Padrão ---
        const defaultData = {
            incomes: [
                { id: 1, name: 'Bolsa', amount: 1421, received: false }
            ],
            fixedExpenses: [
                { 
                    id: 2, 
                    name: 'Fatura Nubank', 
                    isCard: true, 
                    paid: false, 
                    subItems: [
                        { id: 21, name: 'Ração e Areia', amount: 175 },
                        { id: 22, name: 'Academia', amount: 160 }
                    ] 
                }
            ],
            budgets: [
                { id: 'mercado', name: 'Supermercado', limit: 600, icon: 'fa-solid fa-basket-shopping', color: 'bg-retro-orange' },
                { id: 'lazer', name: 'Lazer', limit: 282, icon: 'fa-solid fa-ice-cream', color: 'bg-retro-pink' },
                { id: 'reserva', name: 'Poupança', limit: 300, icon: 'fa-solid fa-piggy-bank', color: 'bg-retro-blue' },
            ],
            dailyExpenses: []
        };

        createApp({
            setup() {
                const user = ref(null);
                const authLoading = ref(true);
                const loading = ref(false);
                const isLogin = ref(true);
                const email = ref('');
                const password = ref('');
                const authError = ref('');

                const activeTab = ref('resumo');
                const incomes = ref([]);
                const fixedExpenses = ref([]);
                const budgets = ref([]);
                const dailyExpenses = ref([]);
                
                const isEditing = ref(false);
                const isProcessing = ref(false);
                const scannedItems = ref([]);
                
                const newItem = ref({ name: '', amount: '', isCard: false });
                const newExpense = ref({ name: '', amount: '', budgetId: 'mercado', items: [] });

                const showModal = ref(false);
                const modalData = ref({ title: '', message: '', action: null });

                onMounted(() => {
                    onAuthStateChanged(auth, async (currentUser) => {
                        user.value = currentUser;
                        if (currentUser) {
                            await loadUserData(currentUser.uid);
                        }
                        authLoading.value = false;
                    });
                });

                const handleAuth = async () => {
                    loading.value = true;
                    authError.value = '';
                    try {
                        if (isLogin.value) {
                            await signInWithEmailAndPassword(auth, email.value, password.value);
                        } else {
                            const res = await createUserWithEmailAndPassword(auth, email.value, password.value);
                            await setDoc(doc(db, 'users', res.user.uid), defaultData);
                        }
                        email.value = ''; password.value = '';
                    } catch (error) {
                        authError.value = 'Erro ao autenticar. Verifica os dados.';
                    }
                    loading.value = false;
                };

                const logout = () => signOut(auth);

                const loadUserData = async (uid) => {
                    const docSnap = await getDoc(doc(db, 'users', uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        incomes.value = data.incomes || [];
                        fixedExpenses.value = data.fixedExpenses || [];
                        budgets.value = data.budgets || defaultData.budgets;
                        dailyExpenses.value = data.dailyExpenses || [];
                    } else {
                        incomes.value = defaultData.incomes;
                        fixedExpenses.value = defaultData.fixedExpenses;
                        budgets.value = defaultData.budgets;
                        dailyExpenses.value = defaultData.dailyExpenses;
                        saveUserData();
                    }
                };

                const saveUserData = async () => {
                    if (!user.value) return;
                    await setDoc(doc(db, 'users', user.value.uid), {
                        incomes: incomes.value,
                        fixedExpenses: fixedExpenses.value,
                        budgets: budgets.value,
                        dailyExpenses: dailyExpenses.value
                    }, { merge: true });
                };

                watch([incomes, fixedExpenses, budgets, dailyExpenses], () => {
                    if(!authLoading.value && user.value) saveUserData();
                }, { deep: true });

                const getExpenseAmount = (exp) => {
                    if (exp.isCard) return (exp.subItems || []).reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                    return parseFloat(exp.amount) || 0;
                };

                const totalIncome = computed(() => incomes.value.reduce((a, c) => a + c.amount, 0));
                const totalFixed = computed(() => fixedExpenses.value.reduce((a, c) => a + getExpenseAmount(c), 0));
                const totalDaily = computed(() => dailyExpenses.value.reduce((a, c) => a + c.amount, 0));
                const balance = computed(() => totalIncome.value - totalFixed.value - totalDaily.value);
                const receivedIncome = computed(() => incomes.value.filter(i => i.received).reduce((a, c) => a + c.amount, 0));
                const paidFixed = computed(() => fixedExpenses.value.filter(e => e.paid).reduce((a, c) => a + getExpenseAmount(c), 0));

                const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
                const getBudgetSpent = (id) => dailyExpenses.value.filter(e => e.budgetId === id).reduce((a, c) => a + c.amount, 0);
                const getBudgetPercentage = (id) => (getBudgetSpent(id) / (budgets.value.find(b => b.id === id)?.limit || 1)) * 100;
                const getBudget = (id) => budgets.value.find(b => b.id === id) || budgets.value[0];
                const toggleStatus = (item, field) => { item[field] = !item[field]; };

                const openModal = (title, message, action) => {
                    modalData.value = { title, message, action };
                    showModal.value = true;
                };
                const confirmModalAction = () => {
                    if(modalData.value.action) modalData.value.action();
                    showModal.value = false;
                };

                const confirmReset = () => {
                    openModal('Limpar o Mês?', 'Isto limpará o status de todas as contas e o histórico de lançamentos. Desejas continuar?', () => {
                        dailyExpenses.value = [];
                        incomes.value.forEach(i => i.received = false);
                        fixedExpenses.value.forEach(e => e.paid = false);
                    });
                };

                const removeItem = (listName, id) => {
                    if(listName === 'incomes') incomes.value = incomes.value.filter(i => i.id !== id);
                    if(listName === 'fixedExpenses') fixedExpenses.value = fixedExpenses.value.filter(i => i.id !== id);
                    if(listName === 'dailyExpenses') dailyExpenses.value = dailyExpenses.value.filter(i => i.id !== id);
                };

                const addItem = (listName) => {
                    if(!newItem.value.name) return;
                    const item = { id: Date.now(), name: newItem.value.name, received: false, paid: false };
                    
                    if(listName === 'incomes') {
                        item.amount = parseFloat(newItem.value.amount) || 0;
                        incomes.value.push(item);
                    } else if(listName === 'fixedExpenses') {
                        if (newItem.value.isCard) {
                            item.isCard = true;
                            item.subItems = [];
                        } else {
                            item.amount = parseFloat(newItem.value.amount) || 0;
                        }
                        fixedExpenses.value.push(item);
                    }
                    newItem.value = { name: '', amount: '', isCard: false };
                };

                const addDailyExpense = () => {
                    if(!newExpense.value.name || !newExpense.value.amount) return;
                    dailyExpenses.value.unshift({
                        id: Date.now(),
                        name: newExpense.value.name,
                        amount: parseFloat(newExpense.value.amount),
                        budgetId: newExpense.value.budgetId,
                        date: new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }),
                        items: scannedItems.value
                    });
                    newExpense.value = { name: '', amount: '', budgetId: 'mercado' };
                    scannedItems.value = [];
                };

                // Lógica de Leitura da Fatura/Nota com Gemini 2.5 Flash
                const handleScan = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    isProcessing.value = true;
                    scannedItems.value = [];
                    
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Image = reader.result.split(',')[1];
                        const prompt = "Analise este recibo/fatura. Extraia o nome do estabelecimento e uma lista dos itens. Para cada item, extraia nome, quantidade (qty) e preço total do item. Retorne estritamente em formato JSON: { 'storeName': 'nome', 'items': [{ 'name': 'item', 'qty': 1, 'price': 10.5 }], 'total': 10.5 }.";

                        let retries = 0;
                        while (retries < 5) {
                            try {
                                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image } }] }]
                                    })
                                });

                                const result = await response.json();
                                const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                                const jsonText = rawText.replace(/```json|```/g, '').trim();
                                const extractedData = JSON.parse(jsonText);

                                newExpense.value = {
                                    name: extractedData.storeName || 'Supermercado',
                                    amount: extractedData.total || 0,
                                    budgetId: 'mercado'
                                };
                                scannedItems.value = extractedData.items || [];
                                break;
                            } catch (error) {
                                retries++;
                                await new Promise(res => setTimeout(res, 1000 * retries));
                            }
                        }
                        isProcessing.value = false;
                        e.target.value = ''; // Reset input
                    };
                    reader.readAsDataURL(file);
                };

                return {
                    user, authLoading, loading, isLogin, email, password, authError, handleAuth, logout,
                    activeTab, incomes, fixedExpenses, budgets, dailyExpenses, isEditing, isProcessing, newItem, newExpense, scannedItems,
                    totalIncome, totalFixed, balance, receivedIncome, paidFixed,
                    formatCurrency, getBudgetSpent, getBudgetPercentage, getBudget, getExpenseAmount, toggleStatus, removeItem, addItem, addDailyExpense, handleScan,
                    showModal, modalData, confirmReset, confirmModalAction
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
